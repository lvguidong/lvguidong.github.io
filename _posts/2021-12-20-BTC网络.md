---
layout: post
title: BTC网络
tags: 
- 区块链
- BlockChain
- BTC
date: 2021-12-20 20:32 +0800
---



# P2P 网络架构

​	⽐特币采⽤了基于国际互联⽹（Internet）的P2P（peer-to-peer）⽹络架构。P2P是指位于同⼀⽹络中的每台计算机都彼此 对等，各个节点共同提供⽹络服务，不存在任何“特殊”节点。每个⽹络节点以“扁平（flat）”的拓扑结构相互连通。在P2P⽹络 中不存在任何服务端（server）、中央化的服务、以及层级结构。P2P⽹络的节点之间交互运作、协同处理：每个节点在对 外提供服务的同时也使⽤⽹络中其他节点所提供的服务。P2P⽹络也因此具有可靠性、去中⼼化，以及开放性。早期的国际 互联⽹就是P2P⽹络架构的⼀个典型⽤例：IP⽹络中的各个节点完全平等。当今的互联⽹架构具有分层架构，但是IP协议仍 然保留了扁平拓扑的结构。在⽐特币之外，规模最⼤也最成功的P2P技术应⽤是在⽂件分享领域：Napster是该领域的先 锋，BitTorrent是其架构的最新演变。

​	⽐特币所采⽤的P2P⽹络架构不仅仅是选择拓扑结构这样简单。⽐特币被设计为⼀种点对点的数字现⾦系统，它的⽹络架构 既是这种核⼼特性的反映，也是该特性的基⽯。去中⼼化控制是设计时的核⼼原则，它只能通过维持⼀种扁平化、去中⼼化 的P2P共识⽹络来实现。

​	“⽐特币⽹络”是按照⽐特币P2P协议运⾏的⼀系列节点的集合。除了⽐特币P2P协议之外，⽐特币⽹络中也包含其他协议。例 如Stratum协议就被应⽤于挖矿、以及轻量级或移动端⽐特币钱包之中。⽹关（gateway）路由服务器提供这些协议，使⽤⽐ 特币P2P协议接⼊⽐特币⽹络，并把⽹络拓展到运⾏其他协议的各个节点。例如，Stratum服务器通过Stratum协议将所有的 Stratum挖矿节点连接⾄⽐特币主⽹络、并将Stratum协议桥接（bridge）⾄⽐特币P2P协议之上。我们使⽤“扩展⽐特币⽹络 （extended bitcoin network）”指代所有包含⽐特币P2P协议、矿池挖矿协议、Stratum协议以及其他连接⽐特币系统组件相 关协议的整体⽹络结构。



# 节点类型及分工

​	尽管⽐特币P2P⽹络中的各个节点相互对等，但是根据所提供的功能不同，各节点可能具有不同的分⼯。每个⽐特币节点都 是路由、区块链数据库、挖矿、钱包服务的功能集合。⼀个全节点（full node）包括如图所⽰的四个功能：

<img src="https://github.com/lvguidong/lvguidong.github.io/blob/main/_posts/images/btc_network1.png?raw=true?raw=true" alt="block-min" style="zoom:80%;" />

​	每个节点都参与全⽹络的路由功能，同时也可能包含其他功能。每个节点都参与验证并传播交易及区块信息，发现并维持与 对等节点的连接。上图所⽰的全节点⽤例中，名为“⽹络路由节点”的橙⾊圆圈即表⽰该路由功能。

​	⼀些节点保有⼀份完整的、最新的区块链拷⻉，这样的节点被称为“`全节点`”。全节点能够独⽴⾃主地校验所有交易，⽽不需 借由任何外部参照。另外还有⼀些节点只保留了区块链的⼀部分，它们通过⼀种名为“简易⽀付验证（SPV）”的⽅式来完成 交易验证。这样的节点被称为“SPV节点”，⼜叫“轻量级节点”。在如上图所⽰的全节点⽤例中，名为完整区块链的蓝⾊圆圈即 表⽰了全节点区块链数据库功能。在图6-3中，SPV节点没有此蓝⾊圆圈，以⽰它们没有区块链的完整拷⻉。

​	挖矿节点通过运⾏在特殊硬件设备上的⼯作量证明（proof-of-work）算法，以相互竞争的⽅式创建新的区块。⼀些挖矿节点 同时也是全节点，保有区块链的完整拷⻉；还有⼀些参与矿池挖矿的节点是轻量级节点，它们必须依赖矿池服务器维护的全 节点进⾏⼯作。在全节点⽤例中，挖矿功能如图中名为“矿⼯”的⿊⾊圆圈所⽰。

​	⽤⼾钱包也可以作为全节点的⼀部分，这在桌⾯⽐特币客⼾端中⽐较常⻅。当前，越来越多的⽤⼾钱包都是SPV节点，尤其 是运⾏于诸如智能⼿机等资源受限设备上的⽐特币钱包应⽤；⽽这正变得越来越普遍。在图中，名为“钱包”的绿⾊圆圈代 表钱包功能。

​	在⽐特币P2P协议中，除了这些主要的节点类型之外，还有⼀些服务器及节点也在运⾏着其他协议，例如特殊矿池挖矿协 议、轻量级客⼾端访问协议等。

​	下图描述了扩展⽐特币⽹络中最为常⻅的节点类型。

<img src="https://github.com/lvguidong/lvguidong.github.io/blob/main/_posts/images/btc_network2.png?raw=true?raw=true" alt="block-min" style="zoom:80%;" />

​	

# 扩展⽐特币⽹络

​	运⾏⽐特币P2P协议的⽐特币主⽹络由⼤约7000-10000个运⾏着不同版本⽐特币核⼼客⼾端（Bitcoin Core）的监听节点、 以及⼏百个运⾏着各类⽐特币P2P协议的应⽤（例如BitcoinJ、Libbitcoin、btcd等）的节点组成。⽐特币P2P⽹络中的⼀⼩ 部分节点也是挖矿节点，它们竞争挖矿、验证交易、并创建新的区块。许多连接到⽐特币⽹络的⼤型公司运⾏着基于Bitcoin 核⼼客⼾端的全节点客⼾端，它们具有区块链的完整拷⻉及⽹络节点，但不具备挖矿及钱包功能。这些节点是⽹络中的边缘 路由器（edge routers），通过它们可以搭建其他服务，例如交易所、钱包、区块浏览器、商家⽀付处理（merchant payment processing）等。

​	扩展⽐特币⽹络既包括了运⾏⽐特币P2P协议的⽹络，⼜包含运⾏特殊协议的⽹络节点。⽐特币P2P主⽹络上 连接着许多矿池服务器以及协议⽹关，它们把运⾏其他协议的节点连接起来。这些节点通常都是矿池挖矿节点（参⻅第8章） 以及轻量级钱包客⼾端，它们通常不具备区块链的完整备份。

​	下图描述了扩展⽐特币⽹络，它包括了多种类型的节点、⽹关服务器、边缘路由器、钱包客⼾端以及它们相互连接所需的各 类协议。

<img src="https://github.com/lvguidong/lvguidong.github.io/blob/main/_posts/images/btc_network3.png?raw=true?raw=true" alt="block-min" style="zoom:100%;" />



#  ⽹络发现

​	当新的⽹络节点启动后，为了能够参与协同运作，它必须发现⽹络中的其他⽐特币节点。新的⽹络节点必须发现⾄少⼀个⽹ 络中存在的节点并建⽴连接。由于⽐特币⽹络的拓扑结构并不基于节点间的地理位置，因此各个节点之间的地理信息完全⽆ 关。在新节点连接时，可以随机选择⽹络中存在的⽐特币节点与之相连。 节点通常采⽤TCP协议、使⽤`8333`端⼝（该端⼝号通常是⽐特币所使⽤的，除8333端⼝外也可以指定使⽤其他端⼝）与已 知的对等节点建⽴连接。在建⽴连接时，该节点会通过发送⼀条包含基本认证内容的version消息开始“握⼿”通信过程。这⼀过程包括如下内容：

- PROTOCOL_VERSION

  常量，定义了客⼾端所“说出”的⽐特币P2P协议所采⽤的版本（例如：70002）。

- nLocalServices

  一组该节点⽀持的本地服务列表，当前仅⽀持NODE_NETWORK

- nTime

  当前时间

- addrYou

  当前节点可⻅的远程节点的IP地址

- addrMe

  本地节点所发现的本机IP地址

- subver

  指⽰当前节点运⾏的软件类型的⼦版本号（例如：”/Satoshi:0.9.2.1/”）

- BaseHeight
  
  当前节点区块链的区块高度
  

​    网络络中的对等节点通过对verack消息的响应进⾏确认并建⽴连接；有时候，如果接收节点需要互换连接并连回起始节点，也 会传回该对等节点的version消息。
​	
​    新节点是如何发现⽹络中的对等节点的呢？虽然⽐特币⽹络中没有特殊节点，但是`客⼾端会维持⼀个列表`，那⾥列出了那些 ⻓期稳定运⾏的节点。这样的节点被称为“**种⼦节点（seed nodes）**”。新节点并不⼀定需要与种⼦节点建⽴连接，但连接到 种⼦节点的好处是可以通过种⼦节点来快速发现⽹络中的其他节点。在⽐特币核⼼客⼾端中，是否使⽤种⼦节点是通过“- dnsseed”控制的。默认情况下，该选项设为1，即意味着使⽤种⼦节点。另⼀种⽅式是，起始时将⾄少⼀个⽐特币节点的IP 地址提供给正在启动的节点（该节点不包含任何⽐特币⽹络的组成信息）。在这之后，启动节点可以通过后续指令建⽴新的 连接。⽤⼾可以使⽤命令⾏参数“-seednode”把启动节点“引荐”并连接到⼀个节点，并将该节点⽤作DNS种⼦。在初始种⼦节 点被⽤于形成“引荐”信息之后，客⼾端会断开与它的连接、并与新发现的对等节点进⾏通信。

​	对等节点之间的初始“握⼿”通信如下：

<img src="https://github.com/lvguidong/lvguidong.github.io/blob/main/_posts/images/btc_network4.png?raw=true?raw=true" alt="block-min" style="zoom:80%;" />

​	

​	当建⽴⼀个或多个连接后，新节点将⼀条包含⾃⾝IP地址的addr消息发送给其相邻节点。相邻节点再将此条addr消息依次转 发给它们各⾃的相邻节点，从⽽保证新节点信息被多个节点所接收、保证连接更稳定。另外，新接⼊的节点可以向它的相邻 节点发送getaddr消息，要求它们返回其已知对等节点的IP地址列表。通过这种⽅式，节点可以找到需连接到的对等节点，并 向⽹络发布它的消息以便其他节点查找。下图描述了这种地址发现协议。

<img src="https://github.com/lvguidong/lvguidong.github.io/blob/main/_posts/images/btc_network5.png?raw=true?raw=true" alt="block-min" style="zoom:80%;" />

​	节点必须连接到`若⼲不同的对等节点`才能在⽐特币⽹络中建⽴通向⽐特币⽹络的种类各异的路径（path）。由于节点可以随 时加⼊和离开，通讯路径是不可靠的。因此，节点必须持续进⾏两项⼯作：在失去已有连接时发现新节点，并在其他节点启 动时为其提供帮助。节点启动时只需要⼀个连接，因为第⼀个节点可以将它引荐给它的对等节点，⽽这些节点⼜会进⼀步提 供引荐。⼀个节点，如果连接到⼤量的其他对等节点，这既没必要，也是对⽹络资源的浪费。在启动完成后，节点会记住它 最近成功连接的对等节点；因此，当重新启动后它可以迅速与先前的对等节点⽹络重新建⽴连接。如果先前的⽹络的对等节 点对连接请求⽆应答，该节点可以使⽤种⼦节点进⾏重启动。

​	在运⾏⽐特币核⼼客⼾端的节点上，您可以使⽤ getpeerinfo 命令列出对等节点连接信息：

```
$ bitcoin-cli getpeerinfo
```



```json
[
{
"addr" : "85.213.199.39:8333",
"services" : "00000001",
"lastsend" : 1405634126,
"lastrecv" : 1405634127,
"bytessent" : 23487651,
"bytesrecv" : 138679099,
"conntime" : 1405021768,
"pingtime" : 0.00000000,
"version" : 70002,
"subver" : "/Satoshi:0.9.2.1/",
"inbound" : false,
"startingheight" : 310131,
"banscore" : 0,
"syncnode" : true
},
{
"addr" : "58.23.244.20:8333",
"services" : "00000001",
"lastsend" : 1405634127,
"lastrecv" : 1405634124,
"bytessent" : 4460918,
"bytesrecv" : 8903575,
"conntime" : 1405559628,
"pingtime" : 0.00000000,
"version" : 70001,
"subver" : "/Satoshi:0.8.6/",
"inbound" : false,
"startingheight" : 311074,
"banscore" : 0,
"syncnode" : false
}
]
```



​	⽤⼾可以通过提供 -connect= 选项来指定⼀个或多个IP地址，从⽽达到复写⾃动节点管理功能并指定IP地址列表的⽬ 的。如果采⽤此选项，节点只连接到这些选定的节点IP地址，⽽不会⾃动发现并维护对等节点之间的连接。

​	如果已建⽴的连接没有数据通信，所在的节点会定期发送信息以维持连接。如果节点持续某个连接⻓达`90`分钟没有任何通 信，它会被认为已经从⽹络中断开，⽹络将开始查找⼀个新的对等节点。因此，⽐特币⽹络会随时根据变化的节点及⽹络问 题进⾏动态调整，不需经过中⼼化的控制即可进⾏规模增、减的有机调整。



# 全节点

​	全节点是指维持包含全部交易信息的完整区块链的节点。更加准确地说，这样的节点应当被称为`完整区块链节点`。在⽐特币 发展的早期，所有节点都是全节点；当前的⽐特币核⼼客⼾端也是完整区块链节点。但在过去的两年中出现了许多新型客⼾ 端，它们不需要维持完整的区块链，⽽是作为轻量级客⼾端运⾏ 完整区块链节点保有完整的、最新的包含全部交易信息的⽐特币区块链拷⻉，这样的节点可以独⽴地进⾏建⽴并校验区块 链，从第⼀区块（创世区块）⼀直建⽴到⽹络中最新的区块。完整区块链节点可以独⽴⾃主地校验任何交易信息，⽽不需要 借助任何其他节点或其他信息来源。完整区块节点通过⽐特币⽹络获取包含交易信息的新区块更新，在验证⽆误后将此更新合并⾄本地的区块链拷⻉之中。

​	运⾏完整区块链节点可以给您⼀种纯粹的⽐特币体验：不需借助或信任其他系统即可独⽴地对所有交易信息进⾏验证。辨别 您是否在运⾏全节点是⼗分容易的：只需要查看您的永久性存储设备（如硬盘）是否有超过20GB的空间被⽤来存储完整区块链即可。如果您需要很⼤的磁盘空间、并且同步⽐特币⽹络耗时2⾄3天，那么您使⽤的正是全节点。这就是摆脱中⼼化管 理、获得完全的独⽴⾃由所要付出的代价。

​	尽管⽬前还有⼀些使⽤不同编程语⾔及软件架构的其他的完整区块链客⼾端存在，但是最常⽤的仍然是`⽐特币核⼼客⼾端`， 它也被称为“`Satoshi客⼾端`”。⽐特币⽹络中超过90%的节点运⾏着各个版本的⽐特币核⼼客⼾端。如前⽂所述，它可以通过 节点间发送的version消息或通过getpeerinfo命令所得到的⼦版本字符串“Satoshi”加以辨识，例如 /Satoshi: 0.8.6/。





